name: Deploy EduPortal

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Wait for Tailscale
        run: sleep 5

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Deploy files to server via rsync over SSH
        env:
          HOST: ${{ secrets.SERVER_HOST }}
          USER: ${{ secrets.SERVER_USER }}
          KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          set -e

          echo "$KEY" > key.pem
          chmod 600 key.pem

          SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=15 -o ServerAliveCountMax=12 -o TCPKeepAlive=yes"

          ssh $SSH_OPTS $USER@$HOST "mkdir -p /var/www/eduportal"

          rsync -a --delete \
            --exclude ".git/" \
            --partial --partial-dir=.rsync-partial \
            --timeout=120 \
            -e "ssh $SSH_OPTS" \
            ./ $USER@$HOST:/var/www/eduportal/
